title: CVE-2023-22515 Confluence Broken Authentication
author: Bmth
tags:
  - CVE-2023-22515
  - Confluence
top_img: 'https://img-blog.csdnimg.cn/1edf094c48a445d596d149356ca305fe.png'
cover: 'https://img-blog.csdnimg.cn/1edf094c48a445d596d149356ca305fe.png'
categories:
  - 漏洞分析
date: 2023-11-05 02:41:00
---
![](https://img-blog.csdnimg.cn/1edf094c48a445d596d149356ca305fe.png)

虽迟但到，CVSS评分为10分的漏洞，还是值得看看的

官方通告：
[https://jira.atlassian.com/browse/CONFSERVER-92475](https://jira.atlassian.com/browse/CONFSERVER-92475)
[https://confluence.atlassian.com/security/cve-2023-22515-broken-access-control-vulnerability-in-confluence-data-center-and-server-1295682276.html](https://confluence.atlassian.com/security/cve-2023-22515-broken-access-control-vulnerability-in-confluence-data-center-and-server-1295682276.html)

影响版本：
```
 8.0.0, 8.1.0, 8.2.0, 8.3.0, 8.4.0, 8.5.0, 8.0.1, 8.0.2, 8.0.3, 8.0.4, 8.1.1, 8.1.3, 8.2.1, 8.1.4, 8.2.2, 8.2.3, 8.3.1, 8.3.2, 8.4.1, 8.4.2, 8.5.1 
```

## 漏洞分析
下载存在漏洞的版本以及修复版本：
```
https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.5.1.zip
https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.5.2.zip
```
添加动态调试，找到service的名字，执行`tomcat9w.exe //ES//Confluence041123021026`
![](https://img-blog.csdnimg.cn/d661a18cf35e4185b3dc70e00a61d6cf.png)

在Java Options添加
```
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
```


### XWork框架
Confluence 使用了 XWork 框架，它允许通过 HTTP 请求来设置 Java 对象的参数：[XWork Plugin Complex Parameters and Security](https://developer.atlassian.com/server/confluence/xwork-plugin-complex-parameters-and-security/)
>XWork allows the setting of complex parameters on an XWork action object. For example, a URL parameter of `formData.name=Charles` will be translated by XWork into the method calls `getFormData().setName("Charles")` by the XWork parameters interceptor. If `getFormData()` returns null, XWork will attempt to create a new object of the appropriate return type using its default constructor, and then set it with `setFormData(newObject)`

而Confluence的处理方案是使用SafeParametersInterceptor拦截器
```xml
<interceptor name="params" class="com.atlassian.xwork.interceptors.SafeParametersInterceptor"/>
```
看到 com.atlassian.struts2_struts-support-1.1.0.jar 中的`com.atlassian.xwork.interceptors.SafeParametersInterceptor#doIntercept`
![](https://img-blog.csdnimg.cn/0f4aea53fbe8419baca94d5a3348754d.png)

首先看到 before 方法
![](https://img-blog.csdnimg.cn/a918afb9db224538bac08b9fe81dc953.png)

调用 filterSafeParameters 对参数进行处理
![](https://img-blog.csdnimg.cn/744e772f29804d758ed870cd7ba788c3.png)

isSafeParameterName
![](https://img-blog.csdnimg.cn/7500d14f6421488c822d402cd7280024.png)

该方法会对传入的参数进行判断，如果包含关键字或者满足正则匹配则返回false
```
BLOCKED_PARAMETER_NAMES: actionErrors、actionMessages
EXCLUDE_CLASS_PATTERN: .*class[^a-z0-9_].*
SAFE_PARAMETER_NAME_PATTERN: \w+((\.\w+)|(\[\d+\])|(\['[\w.]*'\]))*
MAP_PARAMETER_PATTERN: .*\['[a-zA-Z0-9_]+'\]
```
最后会调用 isSafeComplexParameterName 方法
![](https://img-blog.csdnimg.cn/7042ae3b3e1a4f06a039a184b6841cfa.png)

检查该类的 getter / setter 或者其 returnType 是否使用了`@ParameterSafe`注解
```java
private static boolean isSafeMethod(Method writeMethod) {
    boolean isAnnotationTrue = false;
    boolean isReturnTypeTrue = false;
    if (writeMethod != null) {
        isAnnotationTrue = writeMethod.getAnnotation(ParameterSafe.class) != null;
    }

    if (writeMethod.getReturnType() != null) {
        isReturnTypeTrue = writeMethod.getReturnType().getAnnotation(ParameterSafe.class) != null;
    }

    return isAnnotationTrue || isReturnTypeTrue;
}
```
如果没有实现`@ParameterSafe`注解，那么 isSafeMethod 就会返回 false

这么一看，漏洞成立需要绕过黑名单验证，并且满足`@ParameterSafe`注解，利用条件十分苛刻

但怪就怪在它又调用了`super.doIntercept(invocation)`，即 Struts2 自带的 ParametersInterceptor 重新处理了一遍参数
![](https://img-blog.csdnimg.cn/c645b35bc3674e9c8ae96bb92c5ccce0.png)

而这就导致属性覆盖，因此 v8.x 版本可以被利用

### 补丁比较
diff一下 com.atlassian.confluence_confluence-8.5.1.jar 和 com.atlassian.confluence_confluence-8.5.2.jar 文件

struts.xml：
![](https://img-blog.csdnimg.cn/2a70dbb8ebea48a6b161baa3c8704092.png)

主要是删除了server-info action
看到`com.atlassian.confluence.core.actions.ServerInfoAction`
![](https://img-blog.csdnimg.cn/c38470f66e124121870891c7d580fb34.png)

该类本身没什么特别的，主要是父类ConfluenceActionSupport
`com.atlassian.confluence.core.ConfluenceActionSupport`
![](https://img-blog.csdnimg.cn/5085f88791d548fe932315b639055ebc.png)

有一个getter方法叫`getBootstrapStatusProvider()`，这个方法能够获取 BootstrapStatusProviderImpl 实例
`com.atlassian.confluence.impl.setup.BootstrapStatusProviderImpl`
![](https://img-blog.csdnimg.cn/bca82d824aab442899986b9b94eb48bb.png)

根据补丁可以看到修改了 getApplicationConfig 和 getSetupPersister 方法，将对象设置为ReadOnly
`com.atlassian.config.ApplicationConfig`
![](https://img-blog.csdnimg.cn/3805ca63d50f43bbb9b0d98dd1ebb620.png)

存在 setSetupComplete 方法对 setupComplete 赋值，我们可以设置这个值为false让网站进入未安装完成的状态

看到判断是否安装成功的拦截器
```xml
<interceptor name="setup" class="com.atlassian.confluence.setup.actions.SetupCheckInterceptor"/>
```
![](https://img-blog.csdnimg.cn/8e5f3cddcd4f48d092e6032dbcc87958.png)

正好会判断 setupComplete 这个值

## 漏洞利用
```
/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
```
![](https://img-blog.csdnimg.cn/f5e07712ccba4e40b5969ab9d733cd37.png)

然后访问`/setup/setupadministrator-start.action`添加一个新的管理员用户即可
![](https://img-blog.csdnimg.cn/b81801efeb224fffbb16ad2ae00c199c.png)

其实不止`/server-info.action`，只要是继承了 ConfluenceActionSupport 的action，都存在该漏洞


### 上传插件RCE
X1r0z师傅已经介绍了一种RCE的方法，但是利用条件有限，需要web目录可写并且高权限用户

其实有一种更简单的方法，看到：[https://packetstormsecurity.com/files/175225/Atlassian-Confluence-Unauthenticated-Remote-Code-Execution.html](https://packetstormsecurity.com/files/175225/Atlassian-Confluence-Unauthenticated-Remote-Code-Execution.html)
可以通过上传插件实现RCE，利用工具github上已经存在了：[https://github.com/AIex-3/confluence-hack/](https://github.com/AIex-3/confluence-hack/)
![](https://img-blog.csdnimg.cn/994fc57e96204dc8ac47c7305bd576f0.png)

上传 plugin_shellplug.jar，访问`/plugins/servlet/com.jsos.shell/ShellServlet`
![](https://img-blog.csdnimg.cn/f141f1f026354c9ea0607c44fd36bfba.png)

成功RCE

参考：
[Atlassian Confluence CVE-2023-22515 分析](https://exp10it.cn/2023/10/atlassian-confluence-cve-2023-22515-%E5%88%86%E6%9E%90)
[Confluence 10分漏洞CVE-2023-22515](https://mp.weixin.qq.com/s/W2etlcCDYu-y79Tih7edRA)
[对 Confluence CVE-2023-22515 的一点分析](https://mp.weixin.qq.com/s/rIfYrO1i4LPpgCGyxSLHUg)
[https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis](https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis)

